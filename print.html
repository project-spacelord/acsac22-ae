<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Spacelord Artifact Evaluation</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Preparation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="hub.html"><strong aria-hidden="true">1.1.</strong> Hub Image</a></li><li class="chapter-item expanded "><a href="user-token.html"><strong aria-hidden="true">1.2.</strong> User token & OS image</a></li><li class="chapter-item expanded "><a href="peripheral.html"><strong aria-hidden="true">1.3.</strong> Spacelord peripherals</a></li><li class="chapter-item expanded "><a href="server.html"><strong aria-hidden="true">1.4.</strong> Image and storage server</a></li></ol></li><li class="chapter-item expanded "><a href="testing.html"><strong aria-hidden="true">2.</strong> Testing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Spacelord Artifact Evaluation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>This repository contains artifact evaluation guide for
ACSAC'22 submission
<em>SPACELORD: Private and Secure Smart Space Sharing</em>.</p>
<p>The Spacelord artifacts can be broadly separated into four categories:</p>
<ol>
<li>Hub image (4.3)
<ul>
<li>This is a disk image uploaded to the board.
It contains Spacelord bootloader, image downloader,
and the signature generator.</li>
</ul>
</li>
<li>User token and OS image (4.2, 4.4, 4.5)
<ul>
<li>User token communicates with Spacelord bootloader to upload user image
after verifying the identity of the hub.</li>
<li>We provide reference implementation of user token as a Linux userspace program.</li>
</ul>
</li>
<li>Peripheral image (4.6)
<ul>
<li>Reference implementation of Spacelord protocol on ESP32-based camera device.</li>
</ul>
</li>
<li>Image and storage server</li>
</ol>
<p>All artifacts can be downloaded at this <a href="https://1drv.ms/u/s!Apa8Zxdex5yci51ALONC_FURN_GnNw?e=No9NnK">OneDrive link</a>.</p>
<p><em>Note:</em> &quot;Sledgehammer&quot; is the old codename for this project and may appear in some of the artifacts.</p>
<p>TODO: make this link read-only</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hub-image"><a class="header" href="#hub-image">Hub Image</a></h1>
<ul>
<li>RockPro64: <code>hub-images/rockpro64-downloader.img</code></li>
<li>iMX8MQ: <code>hub-images/imx8mq-evk-downloader.img</code></li>
<li>QEMU (for artifact evaluation without hardware): <code>hub-images/qemu-downloader.img</code> and <code>run-qemu.sh</code>.</li>
</ul>
<p>For hardware based evaluation,
the target board, an NVME SSD, and an eMMC card are required.
Download the corresponding hub image
and upload the image to the eMMC card with a disk flashing tool
(e.g., Etcher, dd - <a href="https://wiki.radxa.com/Rockpi4/install/eMMC">example</a>).</p>
<p>To minimize the hardware requirement,
we disabled TPM requirement for RockPro64 hub image.
TPM requirement do not affect the system performance
because TPM is only used to store secret keys at the boot stage.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="user-token"><a class="header" href="#user-token">User Token</a></h1>
<p>User token verifies the current status of Spacelord hub
and hands over space configuration
and user secrets (e.g., LUKS password)
once the hub's identity and the integrity are verified.</p>
<p>User token can be downloaded at <code>token</code>
which is a static Linux binary.
Please add the execution permission (<code>chmod +x ./token</code>) after downloading it.</p>
<h2 id="user-os-image"><a class="header" href="#user-os-image">User OS Image</a></h2>
<p>Spacelord compatible user OS images establish a connection with the user token after booting the kernel.
After the identity and the integrity of the board is confirmed by the user token,
the user token sends over the user secrets that are required to decrypt the user layer.</p>
<p>Sample user OS image for each board can be downloaded at the following locations.
Decompress the downloaded image <strong>and keep the original <code>.lz4</code> file</strong>.</p>
<ul>
<li>RockPro64: <code>os-images/rockPro64-user.img.lz4</code></li>
<li>iMX8MQ: <code>os-images/imx8mq-evk-user.img.lz4</code></li>
<li>QEMU (for artifact evaluation without hardware): <code>hub_images/qemu-user.img.lz4</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="spacelord-peripheral-devices"><a class="header" href="#spacelord-peripheral-devices">Spacelord peripheral devices</a></h1>
<p>A prototype implementation of Spacelord peripheral device that targets ESP-EYE board
can be downloaded at <code>peripheral</code> directory.</p>
<ul>
<li><code>peripheral/secure-hub-peripheral.elf</code></li>
<li><code>peripheral/bootloader.bin</code></li>
<li><code>peripheral/partition-table.bin</code></li>
</ul>
<p>Please check &quot;Build the Project&quot; section in Esperiff documentation
to see how to flash these files to the board.</p>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/linux-macos-setup.html#build-the-project">Linux and macOS</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/windows-setup.html#build-the-project">Windows</a></li>
</ul>
<p>The board communicates with the board through Wi-Fi,
and the prototype used hardcoded Wi-Fi SSID and password.
Please test in the environment where a Wi-Fi with SSID &quot;myssid&quot; and password &quot;mypassword&quot; (without quote, WPA2).
Alternatively, we can provide a binary with alternative SSID/PW upon a reviewer's request.</p>
<p>TODO: check if this is correct SSID/PW</p>
<h2 id="minimal-hub-implementation"><a class="header" href="#minimal-hub-implementation">Minimal hub implementation</a></h2>
<p>The above camera implementation is intended to communicate with OpenHAB hub software through HTTPS protocol (REST).
Both side (the hub and the peripheral) must use TLS client authentication to verify the identity of each other.
To reduce the hassle of setting up a patched OpenHAB,
we provide a CLI program written in Rust that performs the Sledgehammer TLS authentication.</p>
<ul>
<li>Use <code>peripheral/hub-x86_64</code> to perform peripheral test on a laptop</li>
<li>Use <code>peripheral/hub-aarch64</code> to perform peripheral test with a Spacelord board</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="server-setup"><a class="header" href="#server-setup">Server Setup</a></h1>
<p>Spacelord hub device communicates with an image server and a storage server.
The image server can be any HTTP server
(e.g., <a href="https://github.com/joseluisq/static-web-server">static-web-server</a>,
<a href="https://www.digitalocean.com/community/tutorials/python-simplehttpserver-http-server">Python SimpleHTTPServer</a>)
that can serve static files.
The serving location should be
where <code>.lz4</code> compressed user images are.</p>
<p>Spacelord's remote encrypted storage utilizes iSCSI and WireGuard.
We provide a qcow virtual disk image for the storage server.
Download <code>storage-server/run-storage-server.sh</code> and <code>storage-server.qcow2.lz4</code>
in the same directory and execute <code>run-storage-server.sh</code> to run the storage server.</p>
<p>Currently, <code>run-storage-server.sh</code> assumes that it can forward host port 51820
to the storage server for WireGuard communication. If host port 51820 is
reserved for other purposes, both <code>run-storage-server.sh (hostfwd)</code> and
<code>config.toml (WG_LISTEN_PORT)</code> should be revised accordingly.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="testing"><a class="header" href="#testing">Testing</a></h1>
<h2 id="spacelord-authorized-boot-testing"><a class="header" href="#spacelord-authorized-boot-testing">Spacelord authorized boot testing</a></h2>
<p>Make sure to download artifacts listed in the <a href="introduction.html">introduction page</a>
based on your hardware requirement.</p>
<h3 id="preconfiguration"><a class="header" href="#preconfiguration">Preconfiguration</a></h3>
<ol>
<li>Run the image server
<ul>
<li>Run your favorite HTTP static file server
(e.g., <a href="https://github.com/joseluisq/static-web-server">static-web-server</a>,
<a href="https://www.digitalocean.com/community/tutorials/python-simplehttpserver-http-server">Python SimpleHTTPServer</a>)
at the location where lz4 compressed user images are stored.</li>
</ul>
</li>
<li>Run the storage server
<ul>
<li>Follow the guide in the <a href="server.html">server setup guide page</a>
to run the storage server in QEMU.</li>
</ul>
</li>
<li>Edit <code>config.toml</code> based on the location of the image server and the web server.
<code>server.IMAGE_SERVER_URL</code> should point to the image server including the protocol and the port number
(e.g., <code>http://localhost:8080/</code>).
<code>server.wireguard.ISCSI_TARGET_IP</code> should point to the IP
where the storage server is running without the port number
(e.g., <code>127.0.0.1</code>).
<code>WG_LISTEN_PORT_LOCAL</code> and <code>WG_LISTEN_PORT</code> (as well as <code>run-qemu.sh</code> and <code>run-storage-server.sh</code>)
might have to be changed if the host machine uses these port numbers for other purposes.
All the other settings are hardcoded in the provided storage server image,
so reviewers do not need to modify them (e.g., wireguard subnet IPs).</li>
<li>Put <code>config.toml</code> at the same directory with <code>token</code> program.</li>
<li>Flash the hub image to the board or prepare the QEMU image.</li>
</ol>
<h3 id="sledgehammer-boot-testing"><a class="header" href="#sledgehammer-boot-testing">Sledgehammer boot testing</a></h3>
<ol>
<li>Turn on the hub board
<ul>
<li>Connect the board to the ethernet and turn it on.</li>
<li>For QEMU-based testing, use <code>run-qemu.sh</code> script.
The board will boot into the hub manager
and print a message:
<code>Please connect to &lt;your_ip&gt;</code>.
Remember this IP address.</li>
</ul>
</li>
<li>Run user token program
<ul>
<li>Run user token with the following command:
<code>./token &lt;hub_ip&gt; &lt;os_image&gt;</code>.</li>
<li>The local image name and the name on the image server should match.
Specifically, the hub program looks up <code>${LOCAL_IMAGE_DIR}/${IMAGE_NAME}</code>,
and the hub downloads the image from <code>${IMAGE_SERVER_URL}/${IMAGE_NAME}.lz4</code>.</li>
<li>The token program will connect to the hub manager
(through port number 15758),
sends the location of the image server,
and chooses a nonce for this communication session.</li>
<li>If the communication is successful,
the hub downloads the image and reboots,
and the token program will proceed to the next phase.</li>
</ul>
</li>
<li>Wait for the authenticated boot
<ul>
<li>When the board reboots,
the bootloader calculates the hash of the downloaded image
and generates a certificate based on the measurement result and the nonce.</li>
<li>Concurrently, the token program calculates the expected hash of the user image.
When the hashing is done, the token program waits in a loop
and prints &quot;Waiting for the authenticator...&quot; message until the hub is ready.</li>
<li>When the both parts finish their work,
the board boots into the user OS image and runs the agent application
that performs authenticated key exchange with the user token.
The reference implementation uses TLS client authentication (port number 15759).</li>
<li>If the authentication succeeds,
the user token sends user credentials that are necessary to mount the user layer.</li>
</ul>
</li>
<li>User layer mount
<ul>
<li>As the last step, the user layer is mounted with the credential provided from the user token.</li>
<li>When everything is done, the Linux-based user OS image will launch.</li>
</ul>
</li>
</ol>
<h2 id="peripheral-testing"><a class="header" href="#peripheral-testing">Peripheral testing</a></h2>
<ol>
<li>Setup ESP-EYE device based on the instruction at <a href="peripheral.html">peripheral setup guide</a>.</li>
<li>Run the sample hub binary
<ul>
<li><code>./hub-x86_64 &lt;peripheral_ip&gt;</code> or <code>./hub-aarch64 &lt;peripheral_ip&gt;</code></li>
<li>The hub binary prints CLI menu that can interact with the peripheral.
Internally, both side use TLS client authentication to ensure their identity.</li>
</ul>
</li>
</ol>
<h2 id="performance-testing"><a class="header" href="#performance-testing">Performance testing</a></h2>
<p>Download <code>eval-scripts/phoronix_install_script.sh</code> and <code>eval-scripts/phoronix_run_tests.sh</code>
and upload them to the board after the board boots up.
Run them in the provisioned board to reproduce the performance evaluation in section 6.1.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
